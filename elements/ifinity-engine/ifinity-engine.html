<link rel="import" href="./camera.html">
<link rel="import" href="./emitter.html">
<link rel="import" href="./grid.html">
<link rel="import" href="./level.html">
<link rel="import" href="./sound-player.html">
<link rel="import" href="./asset-loader.html">
<link rel="import" href="./mouse.html">
<script>
    (function (Ifinity) {

        const GRID_SIZE = 40;

        class Engine extends HTMLElement {

            constructor () {
                super();
                this.lastFrame = 0;
            }

            connectedCallback () {
                requestAnimationFrame(() => {
                    this.canvas = document.createElement('canvas');
                    this.appendChild(this.canvas);
                    let rect = this.getBoundingClientRect();
                    this.canvas.width = rect.width;
                    this.canvas.height = rect.height;
                    this.ctx = this.canvas.getContext('2d');
                    this.setup();
                    this.load().then(() => {
                        this.update(0);
                        Ifinity.SoundPlayer.play('startup');
                    });
                });
            }

            setup () {
                Ifinity.Mouse.grab(this);
                Ifinity.Mouse.onClick((e) => {
                    console.log(Math.floor(e.x / GRID_SIZE), Math.floor(e.y / GRID_SIZE));
                });
                this.level = new Ifinity.Level(this.ctx, '01');
                this.level.setup();
                this.camera = new Ifinity.Camera(this.ctx);
                this.grid = new Ifinity.Grid(this.ctx, this.canvas.width, this.canvas.height, GRID_SIZE, "#191B1C");
            }

            load () {
                return Ifinity.AssetLoader.loadBuffer('pwmsyncsweep.wav').then(b => {
                    return Ifinity.SoundPlayer.add('startup', b);
                });
            }

            update (timestamp) {
                let dt = timestamp - this.lastFrame;
                this.lastFrame = timestamp;
                this.level.update(dt);

                this.render();
                requestAnimationFrame(this.update.bind(this));
            }

            render () {
                this.camera.install();
                this.ctx.fillStyle = 'black';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.grid.render();
                this.level.render();
                this.camera.remove();
            }
        }

        Ifinity.Engine = Engine;

        customElements.define('ifinity-engine', Ifinity.Engine);
    })(window.Ifinity = window.Ifinity || {});
</script>
