<link rel="import" href="./emitter.html">
<link rel="import" href="./station.html">
<link rel="import" href="./goal.html">
<link rel="import" href="./world.html">
<script>
    (function (Ifinity) {
        class Level /*extends Ifinity.RenderedObject*/ {

            constructor (ctx, levelId) {
                this.ctx = ctx;

                this.emitters = [];
                this.stations = [];
                this.goals = [];

                this.world = new Ifinity.World();
                this.levelId = levelId;
            }

            setup () {
                fetch(`/levels/${this.levelId}.json`)
                    .then(r => r.json())
                    .then(level => {
                        level.emitters.forEach(emitterData => {
                            let e = new Ifinity.Emitter(this.ctx, this.world);
                            e.x = emitterData.x;
                            e.y = emitterData.y;
                            e.rotation = emitterData.rotation * Math.PI / 180;
                            this.emitters.push(e);
                        });

                        level.stations.forEach((stationData, index) => {
                            let s = new Ifinity.Station(this.ctx, this.world);
                            s.x = stationData.x;
                            s.y = stationData.y;
                            s.data = {
                                angle: stationData.angle
                            };
                            s.id = `station${index}`;
                            this.stations.push(s);
                            this.world.add(s.id, s.x, s.y, s.size, s.data);
                        });

                        level.goals.forEach((goal, index) => {
                            let g = new Ifinity.Goal(this.ctx, this.world);
                            g.x = goal.x;
                            g.y = goal.y;
                            g.data = {
                                "acceptedColor": goal.acceptedColor
                            }
                            g.id = `goal${index}`;
                            console.log("added anew goal", g);
                            this.goals.push(g);
                            this.world.add(g.id, g.x, g.y, g.size, g.data);
                        });
                    });
            }

            update (dt) {
                this.emitters.forEach(emitter => emitter.update(dt));
                this.stations.forEach(station => station.update(dt));
                this.goals.forEach(goal => goal.update(dt));
            }

            render () {
                this.emitters.forEach(emitter => emitter.render());
                this.stations.forEach(station => station.render());
                this.goals.forEach(goal => goal.render());
            }
        }

        Ifinity.Level = Level;

    })(window.Ifinity = window.Ifinity || {});
</script>
